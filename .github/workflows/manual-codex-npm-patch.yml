name: manual-codex-npm-patch

on:
  push:
    branches:
      - manual-codex-npm-patch
  workflow_dispatch:
    inputs:
      release-version:
        description: "Version to embed (e.g. 0.105.0-alpha.5 or 0.105.0)"
        required: true
        type: string

jobs:
  build-windows-patch:
    name: Build Windows patch artifact (@openai/codex)
    runs-on: windows-latest
    timeout-minutes: 45
    env:
      RELEASE_VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.release-version || '0.74.0' }}
    defaults:
      run:
        working-directory: codex-rs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate and apply release version to workspace
        shell: bash
        env:
          CODEX_VERSION: ${{ env.RELEASE_VERSION }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import os
          import pathlib
          import re
          import sys

          version = os.environ["CODEX_VERSION"]
          if not re.fullmatch(r"\d+\.\d+\.\d+(?:-(?:alpha|beta)(?:\.\d+)?)?", version):
              print(
                  "Invalid release-version. Expected x.y.z, x.y.z-alpha, x.y.z-alpha.N, x.y.z-beta, or x.y.z-beta.N",
                  file=sys.stderr,
              )
              sys.exit(1)

          cargo_toml = pathlib.Path("Cargo.toml")
          lines = cargo_toml.read_text(encoding="utf-8").splitlines(keepends=True)

          in_workspace_package = False
          replaced = False
          output: list[str] = []

          for line in lines:
              stripped = line.strip()
              if stripped == "[workspace.package]":
                  in_workspace_package = True
                  output.append(line)
                  continue
              if in_workspace_package and stripped.startswith("[") and stripped.endswith("]"):
                  in_workspace_package = False

              if in_workspace_package and re.match(r'^version\s*=\s*".*"$', stripped):
                  indent = line[: len(line) - len(line.lstrip(" "))]
                  output.append(f'{indent}version = "{version}"\n')
                  replaced = True
                  continue

              output.append(line)

          if not replaced:
              print("Failed to locate [workspace.package].version in Cargo.toml", file=sys.stderr)
              sys.exit(1)

          cargo_toml.write_text("".join(output), encoding="utf-8")
          print(f"Updated workspace version to {version} in {cargo_toml}")
          PY

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.93.0
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build Codex binaries for npm manual patch
        shell: bash
        run: |
          set -euo pipefail
          cargo build \
            --target x86_64-pc-windows-msvc \
            --release \
            --bin codex \
            --bin codex-windows-sandbox-setup \
            --bin codex-command-runner

      - name: Stage patch payload
        shell: bash
        run: |
          set -euo pipefail
          target="x86_64-pc-windows-msvc"
          patch_root="${GITHUB_WORKSPACE}/manual-patch/vendor/${target}/codex"
          mkdir -p "$patch_root"

          cp "target/${target}/release/codex.exe" "$patch_root/codex.exe"
          cp "target/${target}/release/codex-windows-sandbox-setup.exe" "$patch_root/codex-windows-sandbox-setup.exe"
          cp "target/${target}/release/codex-command-runner.exe" "$patch_root/codex-command-runner.exe"

      - name: Write patch instructions
        shell: powershell
        env:
          CODEX_VERSION: ${{ env.RELEASE_VERSION }}
        run: |
          $content = @"
          Embedded Codex version: $env:CODEX_VERSION

          1) Install official package:
             npm i -g @openai/codex

          2) Locate global package directory:
             `$npmRoot = npm root -g
             `$targetDir = Join-Path `$npmRoot "@openai/codex-win32-x64/vendor/x86_64-pc-windows-msvc/codex"

          3) Backup and replace binaries from this artifact:
             codex.exe
             codex-windows-sandbox-setup.exe
             codex-command-runner.exe

          Note: keep existing rg.exe as-is unless you also build and replace it.
          "@
          Set-Content -Path "$env:GITHUB_WORKSPACE\manual-patch\README.txt" -Value $content -Encoding utf8

      - name: Upload manual patch artifact
        uses: actions/upload-artifact@v6
        with:
          name: codex-manual-patch-win32-x64-v${{ env.RELEASE_VERSION }}-${{ github.sha }}
          path: manual-patch/**
          if-no-files-found: error
